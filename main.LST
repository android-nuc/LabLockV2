C51 COMPILER V9.54   MAIN                                                                  10/22/2019 16:07:01 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          
   2          #include<reg52.h>
   3          #include<intrins.h>
   4          #include "main.h"
   5          #include "mfrc522.h"  
   6          #include <string.h>
   7          
   8          typedef unsigned int uint;
   9          unsigned char idata ID[4];
  10          unsigned char idata RevBuffer[30];  
  11          unsigned char status;
  12          unsigned char R_data;
  13          unsigned char i = 0;
  14          unsigned char heart = 0;
  15          void Uart_SendByte(unsigned char Byte);
  16          void lock();
  17          void unlock();
  18          void di(unsigned int x);
  19          void verify();
  20          void process();
  21          void iccardcode();
  22          void Uart_Init();
  23          
  24          
  25          
  26          void lock(){
  27   1          LOCK_A = 1;
  28   1          LOCK_B = 0;
  29   1          delay_10ms(100);
  30   1          LOCK_A = 1;
  31   1          LOCK_B = 1;
  32   1      }
  33          void unlock(){
  34   1          LOCK_A = 0;
  35   1          LOCK_B = 1;
  36   1          delay_10ms(100);
  37   1          LOCK_A = 1;
  38   1          LOCK_B = 1;
  39   1          
  40   1      }
  41          void di(unsigned int x){  //蜂鸣器发声 x是时间
  42   1        unsigned int Count1 = 0,Count2=0,Count3=0,flag=0;
  43   1        x= x*100;
  44   1        while(1){
  45   2            Count1++;
  46   2            Count3++;
  47   2            if(Count1==100)
  48   2            {
  49   3               Count2++;
  50   3               if(Count2 ==4 )
  51   3               {
  52   4                 Count1=0;
  53   4                 Count2=0;
  54   4                 flag=~flag;
  55   4               }
C51 COMPILER V9.54   MAIN                                                                  10/22/2019 16:07:01 PAGE 2   

  56   3             }
  57   2             if(!flag)
  58   2             {
  59   3               BEEP=~BEEP;     
  60   3             }
  61   2            if (Count3 == x){
  62   3              BEEP = 1;
  63   3              return;
  64   3            }
  65   2        
  66   2        }
  67   1         
  68   1      }
  69          
  70          
  71          
  72          void process(){
  73   1        if (R_data == 0xf2){
  74   2          heart = 0;
  75   2          return;
  76   2        }
  77   1        if (R_data == 0x01){
  78   2          unlock();
  79   2          delay_10ms(500);
  80   2          lock();
  81   2          return;
  82   2        }
  83   1        if (R_data == 0x02){
  84   2          di(100);
  85   2          return;
  86   2        }
  87   1      
  88   1      }
  89          
  90          void iccardcode()
  91          {      
  92   1          
  93   1          unsigned char tmp;
  94   1          switch (status){
  95   2            case 0:  // 寻卡
  96   2              LED_WAIT =0;
  97   2              tmp = PcdRequest(0x52,&RevBuffer);
  98   2              if (tmp == 0){
  99   3                status =1;
 100   3              }
 101   2            break;
 102   2            
 103   2            case 1:   //防冲撞获取卡id
 104   2              LED_FAIL =0; 
 105   2              tmp = PcdAnticoll(&ID);
 106   2              if (tmp == 0){
 107   3                status = 2;
 108   3              }else{
 109   3                status = 0;
 110   3              }
 111   2              break;
 112   2            case 2:   //验证卡
 113   2              verify();
 114   2              status =3;
 115   2              break;
 116   2            case 3:  //防止出错
 117   2              PcdAntennaOff(); 
C51 COMPILER V9.54   MAIN                                                                  10/22/2019 16:07:01 PAGE 3   

 118   2              delay_10ms(1);
 119   2              PcdAntennaOn();
 120   2              status = 0;
 121   2            break;
 122   2            
 123   2            default:
 124   2              status =0;
 125   2            break;
 126   2          }
 127   1          HEART_TEST =~HEART_TEST;
 128   1          if (heart >= 100){
 129   2            di(100);
 130   2          }
 131   1          if (heart >= 40){
 132   2            Uart_SendByte(0xf2);
 133   2          }
 134   1          heart++;
 135   1      }
 136          
 137          
 138          
 139          
 140          /********************************************************************
 141          初始化
 142          ***********************************************************************/
 143          void Uart_Init(void)
 144          {
 145   1           TMOD = 0x20;   //定时器工作在定时器1的方式2
 146   1           PCON = 0x00;   //不倍频
 147   1           SCON = 0x50; //串口工作在方式1，并且启动串行接收 
 148   1           TH1 = 0xFD;    //设置波特率 9600
 149   1           TL1 = 0xFd;
 150   1           TR1 = 1;   //启动定时器1
 151   1           ES = 1;    //开串口中断
 152   1           EA = 1;    //开总中断    
 153   1        
 154   1           PcdReset();   //读卡
 155   1           PcdAntennaOff(); 
 156   1           PcdAntennaOn();  
 157   1           M500PcdConfigISOType( 'A' );
 158   1      }
 159          /********************************************************************
 160          * 名称 : Uart_SendByte(uchar Byte)
 161          * 功能 : 串口发送1字节数据
 162          * 输入 : 无
 163          * 输出 : 无
 164          ***********************************************************************/
 165          void Uart_SendByte(unsigned char Byte)
 166          {
 167   1        SBUF =  Byte;
 168   1        while(!TI)                   //如果发送完毕，硬件会置位TI
 169   1        {
 170   2          _nop_();  
 171   2        } 
 172   1      }
 173          /********************************************************************
 174          * 名称 : Main()
 175          * 功能 : 主函数
 176          * 输入 : 无
 177          * 输出 : 无
 178          ***********************************************************************/
 179          void main()
C51 COMPILER V9.54   MAIN                                                                  10/22/2019 16:07:01 PAGE 4   

 180          {
 181   1        Uart_Init();
 182   1        HEART_TEST = 0;
 183   1        while(1)
 184   1        {
 185   2          LED_OK = 1;
 186   2          LED_WAIT = 1;
 187   2          LED_FAIL = 1;
 188   2          iccardcode();
 189   2        }   
 190   1      }
 191          
 192          
 193          
 194          /********************************************************************
 195          * 名称 : Uart_Int()
 196          * 功能 : 串口中断子函数
 197          * 输入 : 无
 198          * 输出 : 无
 199          ***********************************************************************/
 200          void Uart_Int(void) interrupt 4
 201          {
 202   1      //  static uchar i = 7;    //定义为静态变量，当重新进入这个子函数时 i 的值不会发生改变
 203   1        EA = 0;
 204   1        if(RI == 1)   //当硬件接收到一个数据时，RI会置位
 205   1        {
 206   2          R_data= SBUF; 
 207   2          RI = 0;  
 208   2          process();
 209   2        }
 210   1        EA = 1;
 211   1      }
 212          
 213            
 214          void verify(){
 215   1        Uart_SendByte(0xfd);
 216   1      
 217   1        for(i = 0; i <4 ;i++){
 218   2          Uart_SendByte(ID[i]);
 219   2        }
 220   1      }
 221          
 222          
 223          
 224          
 225          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    533    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =     34    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
