C51 COMPILER V9.60.0.0   MAIN                                                              12/17/2019 09:17:24 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\RT\Keil\C51\BIN\C51.EXE main.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          
   2          #include<reg52.h>
   3          #include<intrins.h>
   4          #include "watchdog.h"
   5          #include "main.h"
   6          #include "mfrc522.h"  
   7          #include <string.h>
   8          
   9          typedef unsigned int uint;
  10          unsigned char idata ID[4];
  11          unsigned char idata RevBuffer[30];  
  12          unsigned char status;
  13          unsigned char R_data;
  14          unsigned char i = 0;
  15          unsigned char heart = 0;
  16          void Uart_SendByte(unsigned char Byte);
  17          void lock();
  18          void unlock();
  19          void di(unsigned int x);
  20          void verify();
  21          void process();
  22          void iccardcode();
  23          void Uart_Init();
  24          
  25          
  26          
  27          void lock(){
  28   1          LOCK_A = 1;
  29   1          LOCK_B = 0;
  30   1          delay_10ms(80);
  31   1          LOCK_A = 1;
  32   1          LOCK_B = 1;
  33   1      }
  34          void unlock(){
  35   1          LOCK_A = 0;
  36   1          LOCK_B = 1;
  37   1          delay_10ms(80);
  38   1          LOCK_A = 1;
  39   1          LOCK_B = 1;
  40   1          
  41   1      }
  42          void di(unsigned int x){  //蜂鸣器发声 x是时间
  43   1        unsigned int Count1 = 0,Count2=0,Count3=0,flag=0;
  44   1        x= x*100;
  45   1        while(1){
  46   2          WatchDog_Feed();
  47   2            Count1++;
  48   2            Count3++;
  49   2            if(Count1==100)
  50   2            {
  51   3               Count2++;
  52   3               if(Count2 ==4 )
  53   3               {
  54   4                 Count1=0;
  55   4                 Count2=0;
C51 COMPILER V9.60.0.0   MAIN                                                              12/17/2019 09:17:24 PAGE 2   

  56   4                 flag=~flag;
  57   4               }
  58   3             }
  59   2             if(!flag)
  60   2             {
  61   3               BEEP=~BEEP;     
  62   3             }
  63   2            if (Count3 == x){
  64   3              BEEP = 1;
  65   3              return;
  66   3            }
  67   2        
  68   2        }
  69   1         
  70   1      }
  71          
  72          
  73          
  74          void process(){
  75   1        if (R_data == 0xf2){
  76   2          heart = 0;
  77   2          
  78   2          return;
  79   2        }
  80   1        if (R_data == 0x01){
  81   2          unlock();
  82   2          delay_10ms(500);
  83   2          lock();
  84   2          return;
  85   2        }
  86   1        if (R_data == 0x02){
  87   2          di(100);
  88   2          return;
  89   2        }
  90   1      
  91   1      }
  92          
  93          void iccardcode()
  94          {       
  95   1          unsigned char tmp;
  96   1          switch (status){
  97   2            case 0:  // 寻卡
  98   2              LED_WAIT =0;
  99   2              tmp = PcdRequest(0x52,&RevBuffer);
 100   2              if (tmp == 0){
 101   3                status =1;
 102   3              }
 103   2            break;
 104   2            
 105   2            case 1:   //防冲撞获取卡id
 106   2              LED_FAIL =0; 
 107   2              tmp = PcdAnticoll(&ID);
 108   2              if (tmp == 0){
 109   3                status = 2;
 110   3              }else{
 111   3                status = 0;
 112   3              }
 113   2              break;
 114   2            case 2:   //验证卡
 115   2              verify();
 116   2              status =3;
 117   2              break;
C51 COMPILER V9.60.0.0   MAIN                                                              12/17/2019 09:17:24 PAGE 3   

 118   2            case 3:  //防止出错
 119   2              PcdReset();
 120   2              status = 0;
 121   2            break;
 122   2            
 123   2            default:
 124   2              status =0;
 125   2            break;
 126   2          }
 127   1          HEART_TEST =~HEART_TEST;
 128   1          if (heart >= 200){
 129   2             di(100);
 130   2          }
 131   1          if (heart >= 100){
 132   2            Uart_SendByte(0xf2);
 133   2            status = 3;
 134   2          }
 135   1          heart++;
 136   1      }
 137          
 138          
 139          
 140          
 141          /********************************************************************
 142          初始化
 143          ***********************************************************************/
 144          void Uart_Init(void)
 145          {
 146   1           TMOD = 0x20;   //定时器工作在定时器1的方式2
 147   1           PCON = 0x00;   //不倍频
 148   1           SCON = 0x50; //串口工作在方式1，并且启动串行接收 
 149   1           TH1 = 0xFD;    //设置波特率 9600
 150   1           TL1 = 0xFd;
 151   1           TR1 = 1;   //启动定时器1
 152   1           ES = 1;    //开串口中断
 153   1           EA = 1;    //开总中断    
 154   1        
 155   1           PcdReset();   //读卡
 156   1           PcdAntennaOff(); 
 157   1           PcdAntennaOn();  
 158   1           M500PcdConfigISOType( 'A' );
 159   1      }
 160          /********************************************************************
 161          * 名称 : Uart_SendByte(uchar Byte)
 162          * 功能 : 串口发送1字节数据
 163          * 输入 : 无
 164          * 输出 : 无
 165          ***********************************************************************/
 166          void Uart_SendByte(unsigned char Byte)
 167          {
 168   1        SBUF =  Byte;
 169   1        while(!TI)                   //如果发送完毕，硬件会置位TI
 170   1        {
 171   2          _nop_();  
 172   2          WatchDog_Feed();
 173   2        } 
 174   1      }
 175          /********************************************************************
 176          * 名称 : Main()
 177          * 功能 : 主函数
 178          * 输入 : 无
 179          * 输出 : 无
C51 COMPILER V9.60.0.0   MAIN                                                              12/17/2019 09:17:24 PAGE 4   

 180          ***********************************************************************/
 181          void main()
 182          {
 183   1        Uart_Init();
 184   1        HEART_TEST = 0;
 185   1        WatchDog_Init();
*** WARNING C209 IN LINE 185 OF main.c: '_WatchDog_Init': too few actual parameters
 186   1        WatchDog_Enable();
 187   1        
 188   1        while(1)
 189   1        {
 190   2          LED_OK = 1;
 191   2          LED_WAIT = 1;
 192   2          LED_FAIL = 1;
 193   2          iccardcode();
 194   2          WatchDog_Feed();
 195   2        }   
 196   1      }
 197          
 198          
 199          
 200          /********************************************************************
 201          * 名称 : Uart_Int()
 202          * 功能 : 串口中断子函数
 203          * 输入 : 无
 204          * 输出 : 无
 205          ***********************************************************************/
 206          void Uart_Int(void) interrupt 4
 207          {
 208   1      //  static uchar i = 7;    //定义为静态变量，当重新进入这个子函数时 i 的值不会发生改变
 209   1        EA = 0;
 210   1        if(RI == 1)   //当硬件接收到一个数据时，RI会置位
 211   1        {
 212   2          R_data= SBUF; 
 213   2          RI = 0;  
 214   2          process();
 215   2        }
 216   1        EA = 1;
 217   1      }
 218          
 219            
 220          void verify(){
 221   1        Uart_SendByte(0xfd);
 222   1      
 223   1        for(i = 0; i <4 ;i++){
 224   2          Uart_SendByte(ID[i]);
 225   2        }
 226   1      }
 227          
 228          
 229          
 230          
 231          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    589    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =     34    ----
C51 COMPILER V9.60.0.0   MAIN                                                              12/17/2019 09:17:24 PAGE 5   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
